<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tinygrad Transformer (WebGPU)</title>
  <style>
    body { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 18px; }
    input, button, textarea { font: inherit; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    textarea { width: 100%; height: 140px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    pre { background: #f6f6f6; padding: 10px; border-radius: 10px; overflow: auto; }
  </style>
</head>
<body>
  <h2>Tinygrad Transformer (WebGPU)</h2>

  <div class="row">
    <label>Tokens (6 ints 0..9):</label>
    <input id="tokens" value="0,1,2,3,4,5" size="28" />
    <button id="run">Run</button>
  </div>

  <p><b>Status:</b> <span id="status">idle</span></p>
  <pre id="out"></pre>

  <script type="module">
    import model from "./transformer.js";

    const statusEl = document.getElementById("status");
    const outEl = document.getElementById("out");
    const tokensEl = document.getElementById("tokens");
    const runBtn = document.getElementById("run");
    const len = 120
    tokensEl.value = Array.from({ length: len }, () => Math.floor(Math.random() * 10)).join(',');

    function setStatus(s) { statusEl.textContent = s; }

    function parseTokens(s) {
      const xs = s.split(",").map(x => x.trim()).filter(Boolean).map(Number);
      console.log(xs)
      if (xs.length !== len || xs.some(x => !Number.isInteger(x))) {
        throw new Error(`Expected exactly ${len} integers in [0,${len-1}]`);
      }
      return new Int32Array(xs);
    }

    async function initWebGPU() {
      if (!navigator.gpu) throw new Error("WebGPU not available in this browser.");
      const adapter = await navigator.gpu.requestAdapter();
      if (!adapter) throw new Error("No WebGPU adapter available.");
      const device = await adapter.requestDevice();
      return device;
    }

    let device, net;

    async function main() {
      setStatus("requesting WebGPU device...");
      device = await initWebGPU();

      setStatus("loading weights + building pipelines...");
      net = await model.load(device, "./transformer.safetensors");

      setStatus("ready");
      outEl.textContent = "Loaded. Click Run.";
    }


    runBtn.onclick = async () => {
      try {
        const toks = parseTokens(tokensEl.value);
        setStatus("running...");
        const t0 = performance.now();
        const [y] = await net(toks);      // returns [Float32Array]
        const t1 = performance.now();

        const take = 10
        outEl.textContent =
          `latency: ${(t1 - t0).toFixed(2)} ms\n` +
          `output len: ${y.length}\n` +
          `first ${take}: ${Array.from(y.slice(0, take)).map(v => v.toFixed(6)).join(", ")}\n`;

        setStatus("ready");
      } catch (e) {
        setStatus("error");
        outEl.textContent = String(e?.stack || e);
      }
    };

    main().catch(e => {
      setStatus("error");
      outEl.textContent = String(e?.stack || e);
    });
  </script>
</body>
</html>